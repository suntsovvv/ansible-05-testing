---

- name: install on rpm based
  block:
    - name: Get vector distrib
      ansible.builtin.get_url:
        url: "https://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-1.x86_64.rpm"
        dest: "./vector-{{ vector_version }}-1.x86_64.rpm"
        validate_certs: 0
        mode: "0777"

    - name: Install vector packages
      ansible.builtin.yum:
        name:
          - vector-{{ vector_version }}-1.x86_64.rpm
        allow_downgrade: yes
  when: ansible_pkg_mgr == "yum"
  notify: restart vector service
- name: install on deb based
  block:
    - name: Get vector distrib
      become: 1
      ansible.builtin.get_url:
        url: "https://packages.timber.io/vector/{{ vector_version }}/vector_{{ vector_version }}-1_amd64.deb"
        dest: "/tmp/vector.deb"
        validate_certs: 0
        mode: "0777"
    - name: Install vector packages
      become: 1
      ansible.builtin.apt:
         deb: "/tmp/vector.deb"
  when: ansible_pkg_mgr == "apt"
  notify: restart vector service

- name: install on rpm based (dnf packet manager)
  block:
    - name: Get vector distrib
      ansible.builtin.get_url:
        url: "https://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-1.x86_64.rpm"
        dest: "./vector-{{ vector_version }}-1.x86_64.rpm"
        validate_certs: 1
        mode: "0777"

    - name: Install vector packages
      ansible.builtin.dnf:
        name: vector-{{ vector_version }}-1.x86_64.rpm
        disable_gpg_check: 1
  when: ansible_pkg_mgr == "dnf"
  notify: restart vector service

- name: Generate vector config
  ansible.builtin.template: 
    src: vector.yaml.j2 
    dest: "{{ vector_config }}"
  notify: restart vector service
# - name: Configure Vector | ensure what directory exists
#   file:
#     path: "{{ vector_config_dir }}"
#     state: directory
#     mode: 0644

# - name: Configure Vector | Template config
#   ansible.builtin.template:
#     src: vector.yaml.j2
#     mode: 0644
#     dest: "{{ vector_config_dir }}/vector.yml"

# - name: Configure Service | Template systemd unit
#   become: true
#   ansible.builtin.template:
#     src: vector.service.j2
#     dest: /etc/systemd/system/vector.service
#     mode: 0644
#   notify: restart vector service

